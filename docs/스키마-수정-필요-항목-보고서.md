# 🔧 Supabase 스키마 수정 필요 항목 보고서

> **작성일**: 2025-08-30  
> **작성자**: 백엔드 API 실사 조사 결과  
> **우선순위**: 🔴 긴급 (서비스 연동 차단 중)

---

## 📋 수정 필요 항목 요약

백엔드 API 실제 테스트 결과, 스키마 불일치로 인한 오류 발생으로 일부 기능이 차단되고 있습니다.

### 🚨 긴급 수정 필요 (서비스 차단 중)
- business_applications 테이블: 3개 컬럼 누락  
- businesses 테이블: 스키마 정합성 문제
- 권한 관리 테이블: 관리자 인증 연동 문제

---

## 🔴 1. business_applications 테이블 (긴급)

### 발생 오류
```
POST /api/business/apply 호출 시:
"Could not find the 'bank_info' column of 'business_applications' in the schema cache"
```

### 필요한 스키마 수정
```sql
-- 은행 정보 저장 컬럼
ALTER TABLE business_applications 
ADD COLUMN bank_info JSONB DEFAULT '{}';

-- 노출 시간대 설정 컬럼  
ALTER TABLE business_applications 
ADD COLUMN display_time_slots JSONB DEFAULT '{
  "morning": false,
  "lunch": false, 
  "dinner": false,
  "night": false
}';

-- 서류 파일 경로 저장 컬럼
ALTER TABLE business_applications 
ADD COLUMN documents TEXT[] DEFAULT '{}';
```

### 영향받는 기능
- 사업자 등록 신청 완전 차단
- Buzz-Biz 앱의 핵심 기능 불가
- 관리자의 사업자 승인 프로세스 불가

---

## 🟡 2. businesses 테이블 (중요)

### 발생 오류  
```
GET /api/business/list 호출 시:
"BUSINESS_004 - 매장 목록 조회에 실패했습니다"
```

### 추정 원인
1. **인덱스 문제**: status, category 컬럼 인덱스 누락
2. **컬럼 타입 불일치**: JSONB 필드 구조 문제
3. **외래키 제약조건**: user_id 참조 무결성 문제

### 확인 필요 사항
```sql  
-- 1. 테이블 구조 확인
\d businesses;

-- 2. 인덱스 확인
\di businesses;

-- 3. 제약조건 확인  
\d+ businesses;

-- 4. 샘플 데이터 확인
SELECT * FROM businesses LIMIT 3;
```

### 영향받는 기능
- Buzz-App 메인 화면 매장 목록 로딩 실패
- 매장 검색 및 필터링 불가
- 추천 매장 시스템 동작 불가

---

## 🟠 3. 관리자 권한 관리 테이블 (보통)

### 발생 문제
```
GET /api/admin/dashboard/* 호출 시:
"AUTH_001 - 인증 토큰이 필요합니다"
```

### 확인 필요 테이블 구조
```sql
-- 관리자 사용자 테이블 
CREATE TABLE IF NOT EXISTS admin_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  role VARCHAR(50) DEFAULT 'admin',
  permissions JSONB DEFAULT '{}',
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 사용자 역할 테이블
CREATE TABLE IF NOT EXISTS user_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  role VARCHAR(50) NOT NULL,
  assigned_by UUID REFERENCES users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 관리자 권한 세부 테이블
CREATE TABLE IF NOT EXISTS admin_permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_id UUID REFERENCES admin_users(id),
  module VARCHAR(100) NOT NULL,
  permissions JSONB DEFAULT '{"read": true, "write": false, "delete": false}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 영향받는 기능
- Buzz-Admin 전체 기능 접근 불가
- 관리자 대시보드 로딩 실패
- 사업자 승인/거절 프로세스 차단
- 예산 관리 및 정산 관리 불가

---

## 🔵 4. 쿠폰/마일리지 시스템 테이블 (낮음)

### 발생 문제
```
POST /api/coupons/*/generate-qr 호출 시:  
"AUTH_002 - 토큰이 유효하지 않습니다"
```

### JWT 토큰 검증 프로세스 확인 필요
1. **토큰 발급**: 로그인 시 정상 발급 확인 완료 ✅
2. **토큰 검증**: 미들웨어에서 검증 로직 확인 필요
3. **권한 확인**: 사용자 권한별 접근 제어 확인 필요

### 확인 필요 테이블들
```sql
-- 사용자 쿠폰 보유 테이블
SELECT * FROM user_coupons LIMIT 3;

-- 마일리지 계정 테이블  
SELECT * FROM mileage_accounts LIMIT 3;

-- 쿠폰 사용 내역 테이블
SELECT * FROM coupon_usage LIMIT 3;
```

### 영향받는 기능
- QR 코드 생성 기능 차단
- 쿠폰 사용/검증 프로세스 불가
- 마일리지 적립/차감 시스템 불가

---

## ⏰ 수정 우선순위 및 예상 작업 시간

### 🔴 Phase 1: 긴급 수정 (반나절)
1. **business_applications 테이블 컬럼 추가** - 30분
2. **businesses 테이블 스키마 점검** - 1시간  
3. **간단한 테스트 및 검증** - 1시간

### 🟡 Phase 2: 중요 수정 (반나절)  
1. **관리자 권한 테이블 구조 확인** - 1시간
2. **JWT 토큰 검증 로직 점검** - 1.5시간
3. **전체 API 연동 테스트** - 1시간

### 🟠 Phase 3: 통합 테스트 (1일)
1. **3개 앱 모두 백엔드 연결 테스트** - 3시간
2. **시나리오별 엔드투엔드 테스트** - 2시간  
3. **성능 및 안정성 확인** - 2시간

---

## 🎯 수정 후 예상 효과

### 즉시 해결되는 기능들
- ✅ 사업자 등록 신청 및 승인 프로세스  
- ✅ 매장 목록 조회 및 검색 시스템
- ✅ 관리자 대시보드 및 관리 기능
- ✅ QR 코드 기반 쿠폰/마일리지 시스템

### 전체 시스템 연동 완료
- 🚀 **Buzz-App**: 회원가입부터 쿠폰 사용까지 전체 플로우
- 🚀 **Buzz-Admin**: 관리자 로그인부터 예산 관리까지 전체 기능  
- 🚀 **Buzz-Biz**: 사업자 등록부터 정산까지 전체 플로우

**스키마 수정 완료 시, Buzz 플랫폼이 완전한 서비스로 즉시 운영 가능합니다!**