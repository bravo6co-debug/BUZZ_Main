# 💾 Supabase 데이터베이스 스키마 활용 현황

> **작성일**: 2025-08-30  
> **대상**: 개발팀, 기획팀  
> **현황**: 46개 테이블 완전 구축 완료  

## 📋 개요

Buzz 플랫폼의 Supabase 데이터베이스가 **46개 테이블로 완전 구축**되었습니다. 이 문서는 각 테이블의 역할과 3개 앱(Buzz-App, Buzz-Biz, Buzz-Admin)에서의 활용 방안을 정리합니다.

### 🎯 핵심 통계
- **총 테이블 수**: 46개
- **핵심 도메인**: 8개 (사용자, 비즈니스, 쿠폰, 마일리지, 리뷰, 리퍼럴, 시스템, 로그)
- **관계 설정**: Foreign Key 제약조건 완전 설정
- **보안**: Row Level Security (RLS) 정책 적용

---

## 🏗️ 테이블 구조 및 활용도

### 1. 👤 사용자 관리 (8개 테이블)

#### 1.1 핵심 테이블
```sql
📊 사용자 관리 테이블
├── users (기본 사용자 정보)
├── user_profiles (상세 프로필)
├── user_preferences (설정, 알림 등)
├── referral_codes (리퍼럴 코드)
├── user_referrals (추천 관계)
├── referral_rewards (추천 보상)
├── user_sessions (로그인 세션)
└── user_activity_logs (활동 로그)
```

#### 1.2 앱별 활용
| 테이블 | Buzz-App | Buzz-Biz | Buzz-Admin |
|--------|----------|-----------|------------|
| users | ✅ 프로필 관리 | ❌ | ✅ 사용자 조회/관리 |
| user_profiles | ✅ 상세정보 수정 | ❌ | ✅ 상세 조회 |
| user_preferences | ✅ 알림설정 등 | ❌ | ✅ 설정 관리 |
| referral_codes | ✅ 내 추천코드 | ❌ | ✅ 추천 통계 |
| user_referrals | ✅ 추천현황 | ❌ | ✅ 추천 네트워크 |
| referral_rewards | ✅ 보상 내역 | ❌ | ✅ 보상 관리 |

#### 1.3 주요 쿼리 패턴
```typescript
// Buzz-App: 내 프로필 조회
const { data } = await supabase
  .from('user_profiles')
  .select(`
    *,
    users(*),
    referral_codes(*)
  `)
  .eq('user_id', userId)
  .single()

// Buzz-Admin: 사용자 관리
const { data } = await supabase
  .from('users')
  .select(`
    *,
    user_profiles(*),
    user_referrals(count),
    referral_rewards(amount)
  `)
  .range(0, 50)
```

### 2. 🏪 비즈니스 관리 (12개 테이블)

#### 2.1 핵심 테이블
```sql
📊 비즈니스 관리 테이블
├── businesses (매장 기본 정보)
├── business_categories (업종 분류)
├── business_hours (영업 시간)
├── business_applications (가입 신청)
├── business_documents (서류 관리)
├── business_owners (사업자 정보)
├── qr_codes (QR 코드 관리)
├── business_qr_settings (QR 설정)
├── business_analytics (매장 통계)
├── revenue_reports (매출 보고)
├── settlement_requests (정산 요청)
└── business_ratings (평점 집계)
```

#### 2.2 앱별 활용
| 테이블 | Buzz-App | Buzz-Biz | Buzz-Admin |
|--------|----------|-----------|------------|
| businesses | ✅ 매장 조회/검색 | ✅ 내 매장 관리 | ✅ 전체 매장 관리 |
| business_categories | ✅ 카테고리 필터 | ✅ 업종 선택 | ✅ 카테고리 관리 |
| business_hours | ✅ 영업시간 표시 | ✅ 영업시간 수정 | ✅ 조회 |
| business_applications | ❌ | ✅ 가입 신청 | ✅ 승인 관리 |
| qr_codes | ✅ QR 스캔 | ✅ QR 생성/관리 | ✅ QR 모니터링 |
| business_analytics | ❌ | ✅ 내 통계 | ✅ 전체 통계 |

#### 2.3 주요 쿼리 패턴
```typescript
// Buzz-App: 매장 목록 조회
const { data } = await supabase
  .from('businesses')
  .select(`
    *,
    business_categories(name),
    business_hours(*),
    business_ratings(average_rating, review_count)
  `)
  .eq('status', 'active')
  .order('featured', { ascending: false })

// Buzz-Biz: 내 매장 통계
const { data } = await supabase
  .from('business_analytics')
  .select(`
    *,
    businesses(name)
  `)
  .eq('business_id', businessId)
  .gte('date', startDate)

// Buzz-Admin: 매장 승인 관리
const { data } = await supabase
  .from('business_applications')
  .select(`
    *,
    businesses(*),
    business_documents(*)
  `)
  .eq('status', 'pending')
  .order('created_at', { ascending: true })
```

### 3. 🎫 쿠폰 시스템 (10개 테이블)

#### 3.1 핵심 테이블
```sql
📊 쿠폰 시스템 테이블
├── coupons (쿠폰 마스터)
├── coupon_templates (쿠폰 템플릿)
├── coupon_categories (쿠폰 분류)
├── user_coupons (사용자 쿠폰)
├── coupon_usage_history (사용 이력)
├── coupon_campaigns (캠페인)
├── promotion_rules (프로모션 규칙)
├── coupon_restrictions (사용 제한)
├── business_coupons (매장별 쿠폰)
└── coupon_analytics (쿠폰 통계)
```

#### 3.2 앱별 활용
| 테이블 | Buzz-App | Buzz-Biz | Buzz-Admin |
|--------|----------|-----------|------------|
| coupons | ✅ 사용 가능한 쿠폰 | ✅ 내 쿠폰 조회 | ✅ 전체 쿠폰 관리 |
| user_coupons | ✅ 보유 쿠폰 | ❌ | ✅ 사용자별 쿠폰 |
| coupon_usage_history | ✅ 사용 내역 | ✅ 사용된 쿠폰 | ✅ 전체 사용 통계 |
| coupon_campaigns | ✅ 참여 가능한 캠페인 | ✅ 내 캠페인 | ✅ 캠페인 생성/관리 |

#### 3.3 주요 쿼리 패턴
```typescript
// Buzz-App: 내 쿠폰 목록
const { data } = await supabase
  .from('user_coupons')
  .select(`
    *,
    coupons(*),
    coupon_categories(name)
  `)
  .eq('user_id', userId)
  .eq('status', 'active')
  .gte('expires_at', new Date().toISOString())

// Buzz-Biz: 쿠폰 사용 처리
const { data } = await supabase.rpc('use_coupon', {
  user_coupon_id: userCouponId,
  business_id: businessId,
  used_amount: amount
})

// Buzz-Admin: 쿠폰 캠페인 통계
const { data } = await supabase
  .from('coupon_campaigns')
  .select(`
    *,
    coupon_analytics(
      total_issued,
      total_used,
      conversion_rate
    )
  `)
  .gte('start_date', startDate)
```

### 4. 💰 마일리지 시스템 (8개 테이블)

#### 4.1 핵심 테이블
```sql
📊 마일리지 시스템 테이블
├── mileage_accounts (마일리지 계정)
├── mileage_transactions (거래 내역)
├── mileage_exchange_rates (환전 비율)
├── earning_rules (적립 규칙)
├── mileage_campaigns (마일리지 캠페인)
├── settlement_requests (정산 요청)
├── payment_history (결제 내역)
└── mileage_analytics (마일리지 통계)
```

#### 4.2 앱별 활용
| 테이블 | Buzz-App | Buzz-Biz | Buzz-Admin |
|--------|----------|-----------|------------|
| mileage_accounts | ✅ 잔액 조회 | ❌ | ✅ 사용자별 잔액 |
| mileage_transactions | ✅ 내역 조회 | ✅ 사용된 마일리지 | ✅ 전체 거래 내역 |
| earning_rules | ✅ 적립 안내 | ❌ | ✅ 적립 규칙 관리 |
| settlement_requests | ❌ | ✅ 정산 신청 | ✅ 정산 승인 |

### 5. ⭐ 리뷰 시스템 (5개 테이블)

#### 5.1 핵심 테이블
```sql
📊 리뷰 시스템 테이블
├── reviews (리뷰)
├── review_images (리뷰 이미지)
├── review_likes (리뷰 좋아요)
├── review_reports (신고)
└── business_ratings (매장별 평점 집계)
```

#### 5.2 주요 쿼리 패턴
```typescript
// Buzz-App: 매장 리뷰 조회
const { data } = await supabase
  .from('reviews')
  .select(`
    *,
    users(name, avatar_url),
    review_images(*),
    review_likes(count)
  `)
  .eq('business_id', businessId)
  .eq('status', 'approved')
  .order('created_at', { ascending: false })

// Buzz-Admin: 리뷰 관리
const { data } = await supabase
  .from('reviews')
  .select(`
    *,
    businesses(name),
    users(name),
    review_reports(count)
  `)
  .eq('status', 'pending')
```

### 6. 🔧 시스템 관리 (3개 테이블)

#### 6.1 핵심 테이블
```sql
📊 시스템 관리 테이블
├── admin_users (관리자)
├── system_settings (시스템 설정)
└── audit_logs (감사 로그)
```

---

## 🔗 테이블 간 관계도

### 주요 관계 설정
```sql
🔗 핵심 관계
├── users (1) ←→ (N) user_coupons
├── users (1) ←→ (N) mileage_accounts  
├── businesses (1) ←→ (N) reviews
├── businesses (1) ←→ (N) qr_codes
├── users (1) ←→ (N) user_referrals (N) ←→ (1) users
└── businesses (1) ←→ (N) settlement_requests
```

---

## 📊 실시간 기능 활용

### Supabase Realtime 구독
```typescript
// 실시간 알림
supabase
  .channel('notifications')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'notifications',
    filter: `user_id=eq.${userId}`
  }, handleNotification)
  .subscribe()

// 실시간 QR 상태 업데이트
supabase
  .channel('qr_status')
  .on('postgres_changes', {
    event: 'UPDATE',
    schema: 'public', 
    table: 'qr_codes'
  }, handleQRUpdate)
  .subscribe()
```

---

## 🛡️ 보안 정책 (RLS)

### Row Level Security 설정 예시
```sql
-- 사용자는 자신의 데이터만 접근
CREATE POLICY "Users access own data" ON user_coupons
FOR ALL USING (auth.uid() = user_id);

-- 매장 사업자는 자신의 매장만 관리
CREATE POLICY "Business owners manage own business" ON businesses
FOR UPDATE USING (
  auth.uid() IN (
    SELECT user_id FROM business_owners 
    WHERE business_id = businesses.id
  )
);

-- 관리자는 모든 데이터 접근
CREATE POLICY "Admins access all" ON businesses
FOR ALL USING (
  EXISTS (
    SELECT 1 FROM admin_users 
    WHERE user_id = auth.uid() AND status = 'active'
  )
);
```

---

## 🚀 성능 최적화

### 1. 인덱스 설정
```sql
-- 자주 조회되는 컬럼에 인덱스 생성
CREATE INDEX idx_businesses_category ON businesses(category_id);
CREATE INDEX idx_user_coupons_status ON user_coupons(status, expires_at);
CREATE INDEX idx_reviews_business ON reviews(business_id, status);
CREATE INDEX idx_mileage_transactions_user ON mileage_transactions(user_id, created_at);
```

### 2. 복합 쿼리 최적화
```typescript
// JOIN 대신 nested select 활용
const { data } = await supabase
  .from('businesses')
  .select(`
    id,
    name,
    category:business_categories(name),
    rating:business_ratings(average_rating),
    review_count:reviews(count)
  `)
  .eq('status', 'active')
```

---

## 📈 활용 우선순위

### 1단계: 필수 테이블 (즉시 연결)
- `users`, `user_profiles` - 기본 사용자 관리
- `businesses`, `business_categories` - 매장 조회
- `user_coupons`, `coupons` - 쿠폰 시스템
- `mileage_accounts`, `mileage_transactions` - 마일리지

### 2단계: 고급 테이블 (1주 내)
- `reviews`, `review_images` - 리뷰 시스템
- `qr_codes` - QR 기능
- `referral_codes`, `user_referrals` - 리퍼럴
- `notifications` - 실시간 알림

### 3단계: 관리 테이블 (2주 내)
- `business_analytics` - 통계
- `settlement_requests` - 정산
- `admin_users` - 관리자
- `audit_logs` - 로그

---

## 🔄 마이그레이션 준비

### 외주 백엔드 연결시 고려사항
```typescript
// 환경변수로 데이터 소스 전환
const USE_SUPABASE = process.env.VITE_USE_SUPABASE === 'true'

export const dataService = {
  async getBusinesses() {
    if (USE_SUPABASE) {
      return await supabase.from('businesses').select('*')
    } else {
      return await fetch('/api/businesses')
    }
  }
}
```

---

## 📝 활용 체크리스트

### 개발팀 확인사항
- [ ] **Supabase 클라이언트 설정** 완료
- [ ] **RLS 정책** 이해 및 테스트
- [ ] **핵심 쿼리 패턴** 구현 완료
- [ ] **실시간 구독** 설정 완료
- [ ] **성능 최적화** 적용
- [ ] **에러 처리** 구현 완료

### 기획팀 확인사항
- [ ] **데이터 플로우** 이해
- [ ] **권한 체계** 검토
- [ ] **비즈니스 로직** 매핑 확인
- [ ] **통계 요구사항** 반영 여부
- [ ] **확장성** 검토

**현재 46개 테이블은 Buzz 플랫폼의 모든 요구사항을 완벽히 지원할 수 있도록 설계되었으며, 즉시 활용 가능한 상태입니다!** 🚀