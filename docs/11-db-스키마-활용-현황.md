# ğŸ’¾ Supabase ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ í™œìš© í˜„í™©

> **ì‘ì„±ì¼**: 2025-08-30  
> **ëŒ€ìƒ**: ê°œë°œíŒ€, ê¸°íšíŒ€  
> **í˜„í™©**: 46ê°œ í…Œì´ë¸” ì™„ì „ êµ¬ì¶• ì™„ë£Œ  

## ğŸ“‹ ê°œìš”

Buzz í”Œë«í¼ì˜ Supabase ë°ì´í„°ë² ì´ìŠ¤ê°€ **46ê°œ í…Œì´ë¸”ë¡œ ì™„ì „ êµ¬ì¶•**ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ë¬¸ì„œëŠ” ê° í…Œì´ë¸”ì˜ ì—­í• ê³¼ 3ê°œ ì•±(Buzz-App, Buzz-Biz, Buzz-Admin)ì—ì„œì˜ í™œìš© ë°©ì•ˆì„ ì •ë¦¬í•©ë‹ˆë‹¤.

### ğŸ¯ í•µì‹¬ í†µê³„
- **ì´ í…Œì´ë¸” ìˆ˜**: 46ê°œ
- **í•µì‹¬ ë„ë©”ì¸**: 8ê°œ (ì‚¬ìš©ì, ë¹„ì¦ˆë‹ˆìŠ¤, ì¿ í°, ë§ˆì¼ë¦¬ì§€, ë¦¬ë·°, ë¦¬í¼ëŸ´, ì‹œìŠ¤í…œ, ë¡œê·¸)
- **ê´€ê³„ ì„¤ì •**: Foreign Key ì œì•½ì¡°ê±´ ì™„ì „ ì„¤ì •
- **ë³´ì•ˆ**: Row Level Security (RLS) ì •ì±… ì ìš©

---

## ğŸ—ï¸ í…Œì´ë¸” êµ¬ì¡° ë° í™œìš©ë„

### 1. ğŸ‘¤ ì‚¬ìš©ì ê´€ë¦¬ (8ê°œ í…Œì´ë¸”)

#### 1.1 í•µì‹¬ í…Œì´ë¸”
```sql
ğŸ“Š ì‚¬ìš©ì ê´€ë¦¬ í…Œì´ë¸”
â”œâ”€â”€ users (ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´)
â”œâ”€â”€ user_profiles (ìƒì„¸ í”„ë¡œí•„)
â”œâ”€â”€ user_preferences (ì„¤ì •, ì•Œë¦¼ ë“±)
â”œâ”€â”€ referral_codes (ë¦¬í¼ëŸ´ ì½”ë“œ)
â”œâ”€â”€ user_referrals (ì¶”ì²œ ê´€ê³„)
â”œâ”€â”€ referral_rewards (ì¶”ì²œ ë³´ìƒ)
â”œâ”€â”€ user_sessions (ë¡œê·¸ì¸ ì„¸ì…˜)
â””â”€â”€ user_activity_logs (í™œë™ ë¡œê·¸)
```

#### 1.2 ì•±ë³„ í™œìš©
| í…Œì´ë¸” | Buzz-App | Buzz-Biz | Buzz-Admin |
|--------|----------|-----------|------------|
| users | âœ… í”„ë¡œí•„ ê´€ë¦¬ | âŒ | âœ… ì‚¬ìš©ì ì¡°íšŒ/ê´€ë¦¬ |
| user_profiles | âœ… ìƒì„¸ì •ë³´ ìˆ˜ì • | âŒ | âœ… ìƒì„¸ ì¡°íšŒ |
| user_preferences | âœ… ì•Œë¦¼ì„¤ì • ë“± | âŒ | âœ… ì„¤ì • ê´€ë¦¬ |
| referral_codes | âœ… ë‚´ ì¶”ì²œì½”ë“œ | âŒ | âœ… ì¶”ì²œ í†µê³„ |
| user_referrals | âœ… ì¶”ì²œí˜„í™© | âŒ | âœ… ì¶”ì²œ ë„¤íŠ¸ì›Œí¬ |
| referral_rewards | âœ… ë³´ìƒ ë‚´ì—­ | âŒ | âœ… ë³´ìƒ ê´€ë¦¬ |

#### 1.3 ì£¼ìš” ì¿¼ë¦¬ íŒ¨í„´
```typescript
// Buzz-App: ë‚´ í”„ë¡œí•„ ì¡°íšŒ
const { data } = await supabase
  .from('user_profiles')
  .select(`
    *,
    users(*),
    referral_codes(*)
  `)
  .eq('user_id', userId)
  .single()

// Buzz-Admin: ì‚¬ìš©ì ê´€ë¦¬
const { data } = await supabase
  .from('users')
  .select(`
    *,
    user_profiles(*),
    user_referrals(count),
    referral_rewards(amount)
  `)
  .range(0, 50)
```

### 2. ğŸª ë¹„ì¦ˆë‹ˆìŠ¤ ê´€ë¦¬ (12ê°œ í…Œì´ë¸”)

#### 2.1 í•µì‹¬ í…Œì´ë¸”
```sql
ğŸ“Š ë¹„ì¦ˆë‹ˆìŠ¤ ê´€ë¦¬ í…Œì´ë¸”
â”œâ”€â”€ businesses (ë§¤ì¥ ê¸°ë³¸ ì •ë³´)
â”œâ”€â”€ business_categories (ì—…ì¢… ë¶„ë¥˜)
â”œâ”€â”€ business_hours (ì˜ì—… ì‹œê°„)
â”œâ”€â”€ business_applications (ê°€ì… ì‹ ì²­)
â”œâ”€â”€ business_documents (ì„œë¥˜ ê´€ë¦¬)
â”œâ”€â”€ business_owners (ì‚¬ì—…ì ì •ë³´)
â”œâ”€â”€ qr_codes (QR ì½”ë“œ ê´€ë¦¬)
â”œâ”€â”€ business_qr_settings (QR ì„¤ì •)
â”œâ”€â”€ business_analytics (ë§¤ì¥ í†µê³„)
â”œâ”€â”€ revenue_reports (ë§¤ì¶œ ë³´ê³ )
â”œâ”€â”€ settlement_requests (ì •ì‚° ìš”ì²­)
â””â”€â”€ business_ratings (í‰ì  ì§‘ê³„)
```

#### 2.2 ì•±ë³„ í™œìš©
| í…Œì´ë¸” | Buzz-App | Buzz-Biz | Buzz-Admin |
|--------|----------|-----------|------------|
| businesses | âœ… ë§¤ì¥ ì¡°íšŒ/ê²€ìƒ‰ | âœ… ë‚´ ë§¤ì¥ ê´€ë¦¬ | âœ… ì „ì²´ ë§¤ì¥ ê´€ë¦¬ |
| business_categories | âœ… ì¹´í…Œê³ ë¦¬ í•„í„° | âœ… ì—…ì¢… ì„ íƒ | âœ… ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ |
| business_hours | âœ… ì˜ì—…ì‹œê°„ í‘œì‹œ | âœ… ì˜ì—…ì‹œê°„ ìˆ˜ì • | âœ… ì¡°íšŒ |
| business_applications | âŒ | âœ… ê°€ì… ì‹ ì²­ | âœ… ìŠ¹ì¸ ê´€ë¦¬ |
| qr_codes | âœ… QR ìŠ¤ìº” | âœ… QR ìƒì„±/ê´€ë¦¬ | âœ… QR ëª¨ë‹ˆí„°ë§ |
| business_analytics | âŒ | âœ… ë‚´ í†µê³„ | âœ… ì „ì²´ í†µê³„ |

#### 2.3 ì£¼ìš” ì¿¼ë¦¬ íŒ¨í„´
```typescript
// Buzz-App: ë§¤ì¥ ëª©ë¡ ì¡°íšŒ
const { data } = await supabase
  .from('businesses')
  .select(`
    *,
    business_categories(name),
    business_hours(*),
    business_ratings(average_rating, review_count)
  `)
  .eq('status', 'active')
  .order('featured', { ascending: false })

// Buzz-Biz: ë‚´ ë§¤ì¥ í†µê³„
const { data } = await supabase
  .from('business_analytics')
  .select(`
    *,
    businesses(name)
  `)
  .eq('business_id', businessId)
  .gte('date', startDate)

// Buzz-Admin: ë§¤ì¥ ìŠ¹ì¸ ê´€ë¦¬
const { data } = await supabase
  .from('business_applications')
  .select(`
    *,
    businesses(*),
    business_documents(*)
  `)
  .eq('status', 'pending')
  .order('created_at', { ascending: true })
```

### 3. ğŸ« ì¿ í° ì‹œìŠ¤í…œ (10ê°œ í…Œì´ë¸”)

#### 3.1 í•µì‹¬ í…Œì´ë¸”
```sql
ğŸ“Š ì¿ í° ì‹œìŠ¤í…œ í…Œì´ë¸”
â”œâ”€â”€ coupons (ì¿ í° ë§ˆìŠ¤í„°)
â”œâ”€â”€ coupon_templates (ì¿ í° í…œí”Œë¦¿)
â”œâ”€â”€ coupon_categories (ì¿ í° ë¶„ë¥˜)
â”œâ”€â”€ user_coupons (ì‚¬ìš©ì ì¿ í°)
â”œâ”€â”€ coupon_usage_history (ì‚¬ìš© ì´ë ¥)
â”œâ”€â”€ coupon_campaigns (ìº í˜ì¸)
â”œâ”€â”€ promotion_rules (í”„ë¡œëª¨ì…˜ ê·œì¹™)
â”œâ”€â”€ coupon_restrictions (ì‚¬ìš© ì œí•œ)
â”œâ”€â”€ business_coupons (ë§¤ì¥ë³„ ì¿ í°)
â””â”€â”€ coupon_analytics (ì¿ í° í†µê³„)
```

#### 3.2 ì•±ë³„ í™œìš©
| í…Œì´ë¸” | Buzz-App | Buzz-Biz | Buzz-Admin |
|--------|----------|-----------|------------|
| coupons | âœ… ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í° | âœ… ë‚´ ì¿ í° ì¡°íšŒ | âœ… ì „ì²´ ì¿ í° ê´€ë¦¬ |
| user_coupons | âœ… ë³´ìœ  ì¿ í° | âŒ | âœ… ì‚¬ìš©ìë³„ ì¿ í° |
| coupon_usage_history | âœ… ì‚¬ìš© ë‚´ì—­ | âœ… ì‚¬ìš©ëœ ì¿ í° | âœ… ì „ì²´ ì‚¬ìš© í†µê³„ |
| coupon_campaigns | âœ… ì°¸ì—¬ ê°€ëŠ¥í•œ ìº í˜ì¸ | âœ… ë‚´ ìº í˜ì¸ | âœ… ìº í˜ì¸ ìƒì„±/ê´€ë¦¬ |

#### 3.3 ì£¼ìš” ì¿¼ë¦¬ íŒ¨í„´
```typescript
// Buzz-App: ë‚´ ì¿ í° ëª©ë¡
const { data } = await supabase
  .from('user_coupons')
  .select(`
    *,
    coupons(*),
    coupon_categories(name)
  `)
  .eq('user_id', userId)
  .eq('status', 'active')
  .gte('expires_at', new Date().toISOString())

// Buzz-Biz: ì¿ í° ì‚¬ìš© ì²˜ë¦¬
const { data } = await supabase.rpc('use_coupon', {
  user_coupon_id: userCouponId,
  business_id: businessId,
  used_amount: amount
})

// Buzz-Admin: ì¿ í° ìº í˜ì¸ í†µê³„
const { data } = await supabase
  .from('coupon_campaigns')
  .select(`
    *,
    coupon_analytics(
      total_issued,
      total_used,
      conversion_rate
    )
  `)
  .gte('start_date', startDate)
```

### 4. ğŸ’° ë§ˆì¼ë¦¬ì§€ ì‹œìŠ¤í…œ (8ê°œ í…Œì´ë¸”)

#### 4.1 í•µì‹¬ í…Œì´ë¸”
```sql
ğŸ“Š ë§ˆì¼ë¦¬ì§€ ì‹œìŠ¤í…œ í…Œì´ë¸”
â”œâ”€â”€ mileage_accounts (ë§ˆì¼ë¦¬ì§€ ê³„ì •)
â”œâ”€â”€ mileage_transactions (ê±°ë˜ ë‚´ì—­)
â”œâ”€â”€ mileage_exchange_rates (í™˜ì „ ë¹„ìœ¨)
â”œâ”€â”€ earning_rules (ì ë¦½ ê·œì¹™)
â”œâ”€â”€ mileage_campaigns (ë§ˆì¼ë¦¬ì§€ ìº í˜ì¸)
â”œâ”€â”€ settlement_requests (ì •ì‚° ìš”ì²­)
â”œâ”€â”€ payment_history (ê²°ì œ ë‚´ì—­)
â””â”€â”€ mileage_analytics (ë§ˆì¼ë¦¬ì§€ í†µê³„)
```

#### 4.2 ì•±ë³„ í™œìš©
| í…Œì´ë¸” | Buzz-App | Buzz-Biz | Buzz-Admin |
|--------|----------|-----------|------------|
| mileage_accounts | âœ… ì”ì•¡ ì¡°íšŒ | âŒ | âœ… ì‚¬ìš©ìë³„ ì”ì•¡ |
| mileage_transactions | âœ… ë‚´ì—­ ì¡°íšŒ | âœ… ì‚¬ìš©ëœ ë§ˆì¼ë¦¬ì§€ | âœ… ì „ì²´ ê±°ë˜ ë‚´ì—­ |
| earning_rules | âœ… ì ë¦½ ì•ˆë‚´ | âŒ | âœ… ì ë¦½ ê·œì¹™ ê´€ë¦¬ |
| settlement_requests | âŒ | âœ… ì •ì‚° ì‹ ì²­ | âœ… ì •ì‚° ìŠ¹ì¸ |

### 5. â­ ë¦¬ë·° ì‹œìŠ¤í…œ (5ê°œ í…Œì´ë¸”)

#### 5.1 í•µì‹¬ í…Œì´ë¸”
```sql
ğŸ“Š ë¦¬ë·° ì‹œìŠ¤í…œ í…Œì´ë¸”
â”œâ”€â”€ reviews (ë¦¬ë·°)
â”œâ”€â”€ review_images (ë¦¬ë·° ì´ë¯¸ì§€)
â”œâ”€â”€ review_likes (ë¦¬ë·° ì¢‹ì•„ìš”)
â”œâ”€â”€ review_reports (ì‹ ê³ )
â””â”€â”€ business_ratings (ë§¤ì¥ë³„ í‰ì  ì§‘ê³„)
```

#### 5.2 ì£¼ìš” ì¿¼ë¦¬ íŒ¨í„´
```typescript
// Buzz-App: ë§¤ì¥ ë¦¬ë·° ì¡°íšŒ
const { data } = await supabase
  .from('reviews')
  .select(`
    *,
    users(name, avatar_url),
    review_images(*),
    review_likes(count)
  `)
  .eq('business_id', businessId)
  .eq('status', 'approved')
  .order('created_at', { ascending: false })

// Buzz-Admin: ë¦¬ë·° ê´€ë¦¬
const { data } = await supabase
  .from('reviews')
  .select(`
    *,
    businesses(name),
    users(name),
    review_reports(count)
  `)
  .eq('status', 'pending')
```

### 6. ğŸ”§ ì‹œìŠ¤í…œ ê´€ë¦¬ (3ê°œ í…Œì´ë¸”)

#### 6.1 í•µì‹¬ í…Œì´ë¸”
```sql
ğŸ“Š ì‹œìŠ¤í…œ ê´€ë¦¬ í…Œì´ë¸”
â”œâ”€â”€ admin_users (ê´€ë¦¬ì)
â”œâ”€â”€ system_settings (ì‹œìŠ¤í…œ ì„¤ì •)
â””â”€â”€ audit_logs (ê°ì‚¬ ë¡œê·¸)
```

---

## ğŸ”— í…Œì´ë¸” ê°„ ê´€ê³„ë„

### ì£¼ìš” ê´€ê³„ ì„¤ì •
```sql
ğŸ”— í•µì‹¬ ê´€ê³„
â”œâ”€â”€ users (1) â†â†’ (N) user_coupons
â”œâ”€â”€ users (1) â†â†’ (N) mileage_accounts  
â”œâ”€â”€ businesses (1) â†â†’ (N) reviews
â”œâ”€â”€ businesses (1) â†â†’ (N) qr_codes
â”œâ”€â”€ users (1) â†â†’ (N) user_referrals (N) â†â†’ (1) users
â””â”€â”€ businesses (1) â†â†’ (N) settlement_requests
```

---

## ğŸ“Š ì‹¤ì‹œê°„ ê¸°ëŠ¥ í™œìš©

### Supabase Realtime êµ¬ë…
```typescript
// ì‹¤ì‹œê°„ ì•Œë¦¼
supabase
  .channel('notifications')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'notifications',
    filter: `user_id=eq.${userId}`
  }, handleNotification)
  .subscribe()

// ì‹¤ì‹œê°„ QR ìƒíƒœ ì—…ë°ì´íŠ¸
supabase
  .channel('qr_status')
  .on('postgres_changes', {
    event: 'UPDATE',
    schema: 'public', 
    table: 'qr_codes'
  }, handleQRUpdate)
  .subscribe()
```

---

## ğŸ›¡ï¸ ë³´ì•ˆ ì •ì±… (RLS)

### Row Level Security ì„¤ì • ì˜ˆì‹œ
```sql
-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë°ì´í„°ë§Œ ì ‘ê·¼
CREATE POLICY "Users access own data" ON user_coupons
FOR ALL USING (auth.uid() = user_id);

-- ë§¤ì¥ ì‚¬ì—…ìëŠ” ìì‹ ì˜ ë§¤ì¥ë§Œ ê´€ë¦¬
CREATE POLICY "Business owners manage own business" ON businesses
FOR UPDATE USING (
  auth.uid() IN (
    SELECT user_id FROM business_owners 
    WHERE business_id = businesses.id
  )
);

-- ê´€ë¦¬ìëŠ” ëª¨ë“  ë°ì´í„° ì ‘ê·¼
CREATE POLICY "Admins access all" ON businesses
FOR ALL USING (
  EXISTS (
    SELECT 1 FROM admin_users 
    WHERE user_id = auth.uid() AND status = 'active'
  )
);
```

---

## ğŸš€ ì„±ëŠ¥ ìµœì í™”

### 1. ì¸ë±ìŠ¤ ì„¤ì •
```sql
-- ìì£¼ ì¡°íšŒë˜ëŠ” ì»¬ëŸ¼ì— ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_businesses_category ON businesses(category_id);
CREATE INDEX idx_user_coupons_status ON user_coupons(status, expires_at);
CREATE INDEX idx_reviews_business ON reviews(business_id, status);
CREATE INDEX idx_mileage_transactions_user ON mileage_transactions(user_id, created_at);
```

### 2. ë³µí•© ì¿¼ë¦¬ ìµœì í™”
```typescript
// JOIN ëŒ€ì‹  nested select í™œìš©
const { data } = await supabase
  .from('businesses')
  .select(`
    id,
    name,
    category:business_categories(name),
    rating:business_ratings(average_rating),
    review_count:reviews(count)
  `)
  .eq('status', 'active')
```

---

## ğŸ“ˆ í™œìš© ìš°ì„ ìˆœìœ„

### 1ë‹¨ê³„: í•„ìˆ˜ í…Œì´ë¸” (ì¦‰ì‹œ ì—°ê²°)
- `users`, `user_profiles` - ê¸°ë³¸ ì‚¬ìš©ì ê´€ë¦¬
- `businesses`, `business_categories` - ë§¤ì¥ ì¡°íšŒ
- `user_coupons`, `coupons` - ì¿ í° ì‹œìŠ¤í…œ
- `mileage_accounts`, `mileage_transactions` - ë§ˆì¼ë¦¬ì§€

### 2ë‹¨ê³„: ê³ ê¸‰ í…Œì´ë¸” (1ì£¼ ë‚´)
- `reviews`, `review_images` - ë¦¬ë·° ì‹œìŠ¤í…œ
- `qr_codes` - QR ê¸°ëŠ¥
- `referral_codes`, `user_referrals` - ë¦¬í¼ëŸ´
- `notifications` - ì‹¤ì‹œê°„ ì•Œë¦¼

### 3ë‹¨ê³„: ê´€ë¦¬ í…Œì´ë¸” (2ì£¼ ë‚´)
- `business_analytics` - í†µê³„
- `settlement_requests` - ì •ì‚°
- `admin_users` - ê´€ë¦¬ì
- `audit_logs` - ë¡œê·¸

---

## ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤€ë¹„

### ì™¸ì£¼ ë°±ì—”ë“œ ì—°ê²°ì‹œ ê³ ë ¤ì‚¬í•­
```typescript
// í™˜ê²½ë³€ìˆ˜ë¡œ ë°ì´í„° ì†ŒìŠ¤ ì „í™˜
const USE_SUPABASE = process.env.VITE_USE_SUPABASE === 'true'

export const dataService = {
  async getBusinesses() {
    if (USE_SUPABASE) {
      return await supabase.from('businesses').select('*')
    } else {
      return await fetch('/api/businesses')
    }
  }
}
```

---

## ğŸ“ í™œìš© ì²´í¬ë¦¬ìŠ¤íŠ¸

### ê°œë°œíŒ€ í™•ì¸ì‚¬í•­
- [ ] **Supabase í´ë¼ì´ì–¸íŠ¸ ì„¤ì •** ì™„ë£Œ
- [ ] **RLS ì •ì±…** ì´í•´ ë° í…ŒìŠ¤íŠ¸
- [ ] **í•µì‹¬ ì¿¼ë¦¬ íŒ¨í„´** êµ¬í˜„ ì™„ë£Œ
- [ ] **ì‹¤ì‹œê°„ êµ¬ë…** ì„¤ì • ì™„ë£Œ
- [ ] **ì„±ëŠ¥ ìµœì í™”** ì ìš©
- [ ] **ì—ëŸ¬ ì²˜ë¦¬** êµ¬í˜„ ì™„ë£Œ

### ê¸°íšíŒ€ í™•ì¸ì‚¬í•­
- [ ] **ë°ì´í„° í”Œë¡œìš°** ì´í•´
- [ ] **ê¶Œí•œ ì²´ê³„** ê²€í† 
- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§** ë§¤í•‘ í™•ì¸
- [ ] **í†µê³„ ìš”êµ¬ì‚¬í•­** ë°˜ì˜ ì—¬ë¶€
- [ ] **í™•ì¥ì„±** ê²€í† 

**í˜„ì¬ 46ê°œ í…Œì´ë¸”ì€ Buzz í”Œë«í¼ì˜ ëª¨ë“  ìš”êµ¬ì‚¬í•­ì„ ì™„ë²½íˆ ì§€ì›í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìœ¼ë©°, ì¦‰ì‹œ í™œìš© ê°€ëŠ¥í•œ ìƒíƒœì…ë‹ˆë‹¤!** ğŸš€